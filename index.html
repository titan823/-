<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>Toolbox PWA</title>
    <link id="manifest-link" rel="manifest" href="">
    <meta name="theme-color" id="theme-color-meta" content="#4a90e2">

    <style>
        /* =========================================
           ã‚«ãƒ©ãƒ¼ãƒ†ãƒ¼ãƒå®šç¾©
        ========================================= */
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f0f2f5;
            --bg-tertiary: #fdfdfd;
            --bg-input: #ffffff;
            --bg-button: #4a90e2;
            --bg-button-hover: #357abd;
            --bg-button-action: #777777;
            --bg-button-delete: #e53935;
            --bg-button-save: #30d158;
            --bg-header: #4a90e2;
            --text-primary: #333333;
            --text-secondary: #777777;
            --text-light: #ffffff;
            --border-primary: #cccccc;
            --border-secondary: #dddddd;
            --border-tertiary: #eeeeee;
            --shadow-secondary: rgba(0, 0, 0, 0.1);
            --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }
        body.dark-mode {
            --bg-primary: #1a1a1a;
            --bg-secondary: #101010;
            --bg-tertiary: #252525;
            --bg-input: #303030;
            --bg-button: #007aff;
            --bg-button-action: #666666;
            --bg-header: #007aff;
            --text-primary: #e0e0e0;
            --text-secondary: #aaaaaa;
            --border-primary: #444444;
            --border-secondary: #555555;
            --border-tertiary: #333333;
        }
        body.pastel-pink-mode {
            --bg-primary: #fff5f8;
            --bg-secondary: #ffe6ea;
            --bg-tertiary: #fff0f3;
            --bg-input: #ffffff;
            --bg-button: #ff8fab;
            --bg-button-action: #ffb3c1;
            --bg-header: #ff8fab;
            --text-primary: #5c3c45;
            --text-secondary: #8c6b74;
            --border-primary: #ffc2d7;
            --border-secondary: #ffe0e7;
            --border-tertiary: #fff0f3;
        }
        body.pastel-blue-mode {
            --bg-primary: #f0f8ff;
            --bg-secondary: #e0f0ff;
            --bg-tertiary: #eaf5ff;
            --bg-button: #87cefa;
            --bg-button-action: #add8e6;
            --bg-header: #87cefa;
            --text-primary: #3a5679;
            --text-secondary: #6b87a9;
            --border-primary: #b0dfff;
        }
        body.pastel-yellow-mode {
            --bg-primary: #fffefa;
            --bg-secondary: #fffacd;
            --bg-button: #ffd700;
            --bg-button-action: #ffec8b;
            --bg-header: #ffd700;
            --text-primary: #5d4037;
            --border-primary: #fff0b3;
        }
        body.pastel-purple-mode {
            --bg-primary: #f3e5f5;
            --bg-secondary: #e1bee7;
            --bg-button: #ab47bc;
            --bg-button-action: #ba68c8;
            --bg-header: #ab47bc;
            --text-primary: #4a148c;
            --border-primary: #ce93d8;
        }
        body.pastel-rainbow-mode {
            --bg-primary: #fdfdfd;
            --bg-secondary: #f5f5f5;
            --bg-button: #ff80c0;
            --bg-button-action: #80d0ff;
            --bg-header: linear-gradient(to right, #ffadad, #ffd6a5, #fdffb6, #caffbf, #9bf6ff, #a0c4ff, #bdb2ff, #ffc6ff, #ffadad);
            --text-primary: #333;
        }
        body.turf-mode {
            --bg-primary: #F6F4F9;
            --bg-secondary: #e8f5e9;
            --bg-button: #4CAF50;
            --bg-button-action: #9ccc65;
            --bg-header: #4CAF50;
            --text-primary: #2e7d32;
        }

        /* =========================================
           åŸºæœ¬ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ & ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ï¼ˆç”»é¢é·ç§»ï¼‰
        ========================================= */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: var(--font-family);
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            height: 100dvh;
            overflow: hidden;
            transition: background-color 0.3s, color 0.3s;
        }
        .app-container {
            position: relative;
            height: 100%;
            max-width: 800px;
            margin: 0 auto;
            background-color: var(--bg-primary);
            box-shadow: 0 0 10px var(--shadow-secondary);
            overflow: hidden;
        }

        /* ç”»é¢ï¼ˆã‚¹ã‚¯ãƒªãƒ¼ãƒ³ï¼‰ã®å®šç¾© */
        .screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            background-color: var(--bg-primary);
            transition: transform 0.3s ease-in-out;
            z-index: 0;
        }
        .screen.active { z-index: 1; }
        .screen.dormant { visibility: hidden; }

        #menu-screen { transform: translateX(-100%); }
        #main-screen { transform: translateX(0); }
        #settings-screen { transform: translateX(100%); }

        /* =========================================
           ãƒ˜ãƒƒãƒ€ãƒ¼
        ========================================= */
        .app-header {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            background: var(--bg-header);
            color: var(--text-light);
            flex-shrink: 0;
            z-index: 10;
        }
        .app-header h1 {
            font-size: 18px;
            font-weight: bold;
            margin: 0;
            flex-grow: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .header-button {
            background: transparent;
            border: none;
            color: var(--text-light);
            font-size: 20px;
            padding: 5px;
            min-width: 30px;
            cursor: pointer;
            transition: background-color 0.2s;
            border-radius: 4px;
        }
        .header-button:active { background-color: rgba(255,255,255,0.2); }
        .header-button.left { margin-right: 10px; }
        .header-button.right { margin-left: 10px; }

        .main-content {
            flex-grow: 1;
            overflow-y: auto;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        /* =========================================
           ãƒ¡ã‚¤ãƒ³ç”»é¢ (ãƒ†ã‚­ã‚¹ãƒˆæ•´å½¢ãƒ„ãƒ¼ãƒ«)
        ========================================= */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            font-size: 14px;
            font-weight: bold;
            color: var(--text-secondary);
        }
        
        .paste-btn {
            background-color: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-primary);
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 12px;
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .paste-btn:active {
            background-color: var(--bg-secondary);
        }

        textarea {
            width: 100%;
            flex-grow: 1;
            min-height: 120px;
            padding: 12px;
            border: 1px solid var(--border-primary);
            border-radius: 8px;
            font-size: 15px;
            font-family: monospace;
            background-color: var(--bg-input);
            color: var(--text-primary);
            resize: none;
            transition: border-color 0.3s, background-color 0.3s, color 0.3s;
        }
        textarea:focus { outline: 2px solid var(--bg-button); border-color: transparent; }
        
        .tools-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(105px, 1fr));
            gap: 8px;
        }
        button.tool-btn {
            padding: 12px 6px;
            font-size: 12px;
            font-weight: bold;
            border-radius: 6px;
            border: none;
            background-color: var(--bg-button-action);
            color: var(--text-light);
            cursor: pointer;
            transition: transform 0.1s, filter 0.1s;
        }
        button.tool-btn:active { filter: brightness(0.8); transform: scale(0.98); }

        /* ä»»æ„æ–‡å­—åˆ—ç½®æ›ç”¨UI */
        .custom-replace-container {
            display: flex;
            align-items: center;
            gap: 8px;
            background-color: var(--bg-tertiary);
            padding: 10px;
            border-radius: 8px;
            border: 1px solid var(--border-secondary);
        }
        .custom-replace-container input[type="text"] {
            margin-bottom: 0;
            padding: 8px;
            font-size: 13px;
            flex-grow: 1;
            min-width: 0;
            border: 1px solid var(--border-primary);
            border-radius: 4px;
            background-color: var(--bg-input);
            color: var(--text-primary);
        }
        .custom-replace-container button {
            margin: 0;
            padding: 8px 12px;
            white-space: nowrap;
        }

        .action-row { display: flex; gap: 10px; }
        .primary-btn {
            flex-grow: 1;
            padding: 14px;
            font-size: 16px;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            background-color: var(--bg-button);
            color: var(--text-light);
            cursor: pointer;
        }
        .primary-btn:active { filter: brightness(0.8); }
        .secondary-btn {
            background-color: var(--bg-button-save);
            color: var(--text-light);
            border: none;
            border-radius: 8px;
            padding: 10px;
            font-size: 14px;
            cursor: pointer;
        }
        .char-count { font-size: 12px; font-weight: normal; color: var(--text-secondary); }

        /* =========================================
           ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç”»é¢
        ========================================= */
        .menu-list { list-style: none; padding: 0; }
        .menu-item {
            padding: 15px;
            border: 1px solid var(--border-secondary);
            border-radius: 8px;
            margin-bottom: 10px;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            cursor: pointer;
            transition: background-color 0.2s, border-color 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
            box-shadow: 0 1px 3px var(--shadow-secondary);
        }
        .menu-item:hover { background-color: var(--bg-tertiary); }
        .menu-item.active {
            border: 2px solid var(--bg-button);
            background-color: var(--bg-secondary);
        }
        .menu-item.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .menu-desc {
            font-size: 11px;
            color: var(--text-secondary);
            font-weight: normal;
            display: block;
            margin-top: 4px;
        }

        /* =========================================
           è¨­å®šç”»é¢
        ========================================= */
        .settings-group {
            margin-bottom: 25px;
            padding: 15px;
            border: 1px solid var(--border-tertiary);
            border-radius: 8px;
            background-color: var(--bg-tertiary);
        }
        .settings-group h3 {
            margin-bottom: 15px;
            font-size: 16px;
            color: var(--text-link, var(--bg-button));
            border-bottom: 1px solid var(--border-tertiary);
            padding-bottom: 5px;
        }
        select, input[type="text"] {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-primary);
            border-radius: 5px;
            font-size: 14px;
            margin-bottom: 10px;
            background-color: var(--bg-input);
            color: var(--text-primary);
        }

        /* ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ */
        #toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%) translateY(20px);
            background-color: rgba(0,0,0,0.8);
            color: #fff;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 14px;
            opacity: 0;
            visibility: hidden;
            transition: 0.3s ease;
            z-index: 1000;
        }
        #toast.show {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) translateY(0);
        }
    </style>
</head>
<body>

<div class="app-container">

    <!-- ==========================================
         å·¦ãƒ‘ãƒãƒ«: ãƒ„ãƒ¼ãƒ«é¸æŠãƒ¡ãƒ‹ãƒ¥ãƒ¼
    =========================================== -->
    <div id="menu-screen" class="screen dormant">
        <header class="app-header">
            <h1 style="text-align: right; padding-right: 10px;">ãƒ„ãƒ¼ãƒ«é¸æŠ</h1>
            <button id="back-to-main-from-menu" class="header-button right" aria-label="ãƒ¡ã‚¤ãƒ³ã«æˆ»ã‚‹">ï¼</button>
        </header>
        <main class="main-content">
            <p style="font-size: 12px; color: var(--text-secondary); margin-bottom: 5px;">åˆ©ç”¨ã™ã‚‹ãƒ„ãƒ¼ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„</p>
            <ul class="menu-list">
                <li class="menu-item active">
                    <div>
                        ãƒ†ã‚­ã‚¹ãƒˆæ•´å½¢ãƒ„ãƒ¼ãƒ«
                        <span class="menu-desc">ç©ºç™½ã‚„æ”¹è¡Œã®å‰Šé™¤ã€åŠè§’/å…¨è§’å¤‰æ›ãªã©</span>
                    </div>
                    <span>âœ”ï¸</span>
                </li>
                <li class="menu-item disabled">
                    <div>
                        JSONãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿ãƒ¼
                        <span class="menu-desc">ï¼ˆæº–å‚™ä¸­ï¼‰</span>
                    </div>
                </li>
                <li class="menu-item disabled">
                    <div>
                        Base64 ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰/ãƒ‡ã‚³ãƒ¼ãƒ‰
                        <span class="menu-desc">ï¼ˆæº–å‚™ä¸­ï¼‰</span>
                    </div>
                </li>
            </ul>
        </main>
    </div>

    <!-- ==========================================
         ä¸­å¤®ãƒ‘ãƒãƒ«: ãƒ¡ã‚¤ãƒ³ç”»é¢
    =========================================== -->
    <div id="main-screen" class="screen active">
        <header class="app-header">
            <button id="goto-menu-btn" class="header-button left" aria-label="ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‹ã">â˜°</button>
            <h1 id="main-title">ãƒ†ã‚­ã‚¹ãƒˆæ•´å½¢</h1>
            <button id="goto-settings-btn" class="header-button right" aria-label="è¨­å®šã‚’é–‹ã">âš™</button>
        </header>
        <main class="main-content">
            <div class="section-header">
                <label for="inputText">å…¥åŠ›ãƒ†ã‚­ã‚¹ãƒˆ</label>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <!-- è¿½åŠ : ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã‹ã‚‰è²¼ã‚Šä»˜ã‘ãƒœã‚¿ãƒ³ -->
                    <button id="pasteBtn" class="paste-btn">ğŸ“‹ è²¼ã‚Šä»˜ã‘</button>
                    <span class="char-count" id="inputCount">0æ–‡å­—</span>
                </div>
            </div>
            <textarea id="inputText" placeholder="æ•´å½¢ã—ãŸã„ãƒ†ã‚­ã‚¹ãƒˆã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„..."></textarea>

            <div class="tools-grid">
                <button class="tool-btn" data-action="trimSpace">ç©ºç™½ã‚’å‰Šé™¤</button>
                <button class="tool-btn" data-action="removeEmptyLines">ç©ºè¡Œã‚’å‰Šé™¤</button>
                <button class="tool-btn" data-action="removeBreaks">æ”¹è¡Œã‚’å‰Šé™¤</button>
                <button class="tool-btn" data-action="breaksToSpace">æ”¹è¡Œã‚’ç©ºç™½ã«</button>
                <button class="tool-btn" data-action="toHalfWidth">è‹±æ•°â†’åŠè§’</button>
                <button class="tool-btn" data-action="toFullWidthKana">ã‚«ãƒŠâ†’å…¨è§’</button>
                <button class="tool-btn" data-action="toUpperCase">å¤§æ–‡å­—åŒ–</button>
                <button class="tool-btn" data-action="toLowerCase">å°æ–‡å­—åŒ–</button>
                <button class="tool-btn" data-action="toUmaAbbr" style="background-color: var(--bg-button); color: var(--text-light);">ã‚¦ãƒå¨˜ç•¥ç§°åŒ–</button>
            </div>

            <!-- ä»»æ„æ–‡å­—åˆ—ç½®æ› UI -->
            <div class="custom-replace-container">
                <input type="text" id="replaceSource" placeholder="æ¤œç´¢æ–‡å­—åˆ—">
                <span style="color: var(--text-secondary); font-weight: bold;">â†’</span>
                <input type="text" id="replaceTarget" placeholder="ç½®æ›å¾Œ">
                <button id="replaceBtn" class="tool-btn" style="background-color: var(--bg-button); color: var(--text-light);">ç½®æ›</button>
            </div>

            <div class="section-header">
                <label for="outputText">æ•´å½¢çµæœ</label>
                <span class="char-count" id="outputCount">0æ–‡å­—</span>
            </div>
            <textarea id="outputText" placeholder="ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨çµæœãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚ç›´æ¥ç·¨é›†ã‚‚å¯èƒ½ã§ã™..."></textarea>

            <div class="action-row">
                <button id="clearBtn" class="secondary-btn" style="background-color: var(--bg-button-delete);" title="ã™ã¹ã¦ã‚¯ãƒªã‚¢">ğŸ—‘ï¸</button>
                <button id="applyToInputBtn" class="secondary-btn" title="çµæœã‚’å…¥åŠ›æ¬„ã«æˆ»ã—ã¦ç¶šã‘ã¦å‡¦ç†ã™ã‚‹">ğŸ”¼ ç¶šã‘ã¦å‡¦ç†</button>
                <button id="copyBtn" class="primary-btn">çµæœã‚’ã‚³ãƒ”ãƒ¼ ğŸ“‹</button>
            </div>
        </main>
    </div>

    <!-- ==========================================
         å³ãƒ‘ãƒãƒ«: è¨­å®šç”»é¢
    =========================================== -->
    <div id="settings-screen" class="screen dormant">
        <header class="app-header">
            <button id="back-to-main-from-settings" class="header-button left" aria-label="ãƒ¡ã‚¤ãƒ³ã«æˆ»ã‚‹">ï¼œ</button>
            <h1>è¨­å®š</h1>
        </header>
        <main class="main-content">
            <div class="settings-group">
                <h3>ãƒ‡ã‚¶ã‚¤ãƒ³</h3>
                <label for="theme-select">è¡¨ç¤ºãƒ†ãƒ¼ãƒ:</label>
                <select id="theme-select" aria-label="è¡¨ç¤ºãƒ†ãƒ¼ãƒ">
                    <option value="light">ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰</option>
                    <option value="dark">ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰</option>
                    <option value="pastel-pink">ãƒ‘ã‚¹ãƒ†ãƒ«ãƒ¢ãƒ¼ãƒ‰ğŸ©·</option>
                    <option value="pastel-blue">ãƒ‘ã‚¹ãƒ†ãƒ«ãƒ¢ãƒ¼ãƒ‰ğŸ©µ</option>
                    <option value="pastel-yellow">ãƒ‘ã‚¹ãƒ†ãƒ«ãƒ¢ãƒ¼ãƒ‰ğŸŸ¡</option>
                    <option value="pastel-purple">ãƒ‘ã‚¹ãƒ†ãƒ«ãƒ¢ãƒ¼ãƒ‰ğŸŸ£</option>
                    <option value="pastel-rainbow">ãƒ‘ã‚¹ãƒ†ãƒ«ãƒ¢ãƒ¼ãƒ‰ğŸŒˆ</option>
                    <option value="turf">ã‚¿ãƒ¼ãƒ•ãƒ¢ãƒ¼ãƒ‰ğŸŒ±</option>
                </select>
            </div>
            <div class="settings-group" style="text-align: center;">
                <p style="font-size: 12px; color: var(--text-secondary);">Toolbox PWA v1.6</p>
            </div>
        </main>
    </div>

</div>

<!-- é€šçŸ¥ç”¨ãƒˆãƒ¼ã‚¹ãƒˆ -->
<div id="toast"></div>

<script>
    // ==========================================
    // 1. PWA ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å¯¾å¿œ (å‹•çš„Manifest)
    // ==========================================
    (function initPWA() {
        const manifestJSON = {
            name: "Toolbox PWA",
            short_name: "Toolbox",
            display: "standalone",
            start_url: location.href,
            background_color: "#ffffff",
            theme_color: "#4a90e2",
            icons: [{
                src: "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxOTIiIGhlaWdodD0iMTkyIiB2aWV3Qm94PSIwIDAgMTkyIDE5MiI+PHJlY3Qgd2lkdGg9IjE5MiIgaGVpZ2h0PSIxOTIiIGZpbGw9IiM0YTkwZTIiIHJ4PSI0MCIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSI4MCIgZmlsbD0iI2ZmZiIgZG9taW5hbnQtYmFzZWxpbmU9Im1pZGRsZSIgdGV4dC1hbmNob3I9Im1pZGRsZSI+VDwvdGV4dD48L3N2Zz4=",
                sizes: "192x192",
                type: "image/svg+xml"
            }]
        };
        const manifestBlob = new Blob([JSON.stringify(manifestJSON)], {type: 'application/manifest+json'});
        document.getElementById('manifest-link').href = URL.createObjectURL(manifestBlob);

        const swCode = `self.addEventListener('fetch', e => {});`;
        const swBlob = new Blob([swCode], {type: 'application/javascript'});
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register(URL.createObjectURL(swBlob)).catch(()=>{});
        }
    })();

    // ==========================================
    // 2. ç”»é¢é·ç§» (ã‚¹ã‚¯ãƒªãƒ¼ãƒ³) ãƒ­ã‚¸ãƒƒã‚¯
    // ==========================================
    const screens = {
        main: document.getElementById('main-screen'),
        menu: document.getElementById('menu-screen'),
        settings: document.getElementById('settings-screen')
    };

    function showScreen(targetScreen) {
        Object.values(screens).forEach(screen => {
            screen.classList.remove('active');
            screen.classList.remove('dormant');
        });

        if (targetScreen === 'main') {
            screens.main.style.transform = 'translateX(0)';
            screens.menu.style.transform = 'translateX(-100%)';
            screens.settings.style.transform = 'translateX(100%)';
            screens.main.classList.add('active');
        } else if (targetScreen === 'menu') {
            screens.main.style.transform = 'translateX(100%)';
            screens.menu.style.transform = 'translateX(0)';
            screens.settings.style.transform = 'translateX(200%)';
            screens.menu.classList.add('active');
        } else if (targetScreen === 'settings') {
            screens.main.style.transform = 'translateX(-100%)';
            screens.menu.style.transform = 'translateX(-200%)';
            screens.settings.style.transform = 'translateX(0)';
            screens.settings.classList.add('active');
        }

        setTimeout(() => {
            Object.values(screens).forEach(screen => {
                if (!screen.classList.contains('active')) {
                    screen.classList.add('dormant');
                }
            });
        }, 350);
    }

    document.getElementById('goto-menu-btn').addEventListener('click', () => showScreen('menu'));
    document.getElementById('goto-settings-btn').addEventListener('click', () => showScreen('settings'));
    document.getElementById('back-to-main-from-menu').addEventListener('click', () => showScreen('main'));
    document.getElementById('back-to-main-from-settings').addEventListener('click', () => showScreen('main'));

    // ==========================================
    // 3. ãƒ†ãƒ¼ãƒè¨­å®šãƒ­ã‚¸ãƒƒã‚¯
    // ==========================================
    const themeSelect = document.getElementById('theme-select');
    let currentTheme = localStorage.getItem('formatter_theme') || 'light';

    function applyTheme(themeName) {
        document.body.className = ''; 
        if (themeName !== 'light') {
            document.body.classList.add(themeName + '-mode');
        }
        localStorage.setItem('formatter_theme', themeName);
        themeSelect.value = themeName;
        
        const colors = {
            'light': '#4a90e2', 'dark': '#007aff', 'pastel-pink': '#ff8fab',
            'pastel-blue': '#87cefa', 'pastel-yellow': '#ffd700', 'pastel-purple': '#ab47bc',
            'pastel-rainbow': '#ffadad', 'turf': '#4CAF50'
        };
        document.getElementById('theme-color-meta').content = colors[themeName] || '#4a90e2';
    }

    themeSelect.addEventListener('change', (e) => applyTheme(e.target.value));
    applyTheme(currentTheme);

    // ==========================================
    // 4. ãƒ†ã‚­ã‚¹ãƒˆæ•´å½¢ãƒ­ã‚¸ãƒƒã‚¯
    // ==========================================
    const inputEl = document.getElementById('inputText');
    const outputEl = document.getElementById('outputText');
    const inputCount = document.getElementById('inputCount');
    const outputCount = document.getElementById('outputCount');

    function updateCounts() {
        inputCount.textContent = inputEl.value.length + "æ–‡å­—";
        outputCount.textContent = outputEl.value.length + "æ–‡å­—";
    }
    inputEl.addEventListener('input', updateCounts);
    outputEl.addEventListener('input', updateCounts);

    // åŠè§’ã‚«ãƒŠâ†’å…¨è§’ã‚«ãƒŠå¤‰æ›ãƒãƒƒãƒ—
    const kanaMap = {
        'ï½¶ï¾':'ã‚¬','ï½·ï¾':'ã‚®','ï½¸ï¾':'ã‚°','ï½¹ï¾':'ã‚²','ï½ºï¾':'ã‚´','ï½»ï¾':'ã‚¶','ï½¼ï¾':'ã‚¸','ï½½ï¾':'ã‚º','ï½¾ï¾':'ã‚¼','ï½¿ï¾':'ã‚¾',
        'ï¾€ï¾':'ãƒ€','ï¾ï¾':'ãƒ‚','ï¾‚ï¾':'ãƒ…','ï¾ƒï¾':'ãƒ‡','ï¾„ï¾':'ãƒ‰','ï¾Šï¾':'ãƒ','ï¾‹ï¾':'ãƒ“','ï¾Œï¾':'ãƒ–','ï¾ï¾':'ãƒ™','ï¾ï¾':'ãƒœ',
        'ï¾Šï¾Ÿ':'ãƒ‘','ï¾‹ï¾Ÿ':'ãƒ”','ï¾Œï¾Ÿ':'ãƒ—','ï¾ï¾Ÿ':'ãƒš','ï¾ï¾Ÿ':'ãƒ','ï½³ï¾':'ãƒ´',
        'ï½±':'ã‚¢','ï½²':'ã‚¤','ï½³':'ã‚¦','ï½´':'ã‚¨','ï½µ':'ã‚ª','ï½¶':'ã‚«','ï½·':'ã‚­','ï½¸':'ã‚¯','ï½¹':'ã‚±','ï½º':'ã‚³',
        'ï½»':'ã‚µ','ï½¼':'ã‚·','ï½½':'ã‚¹','ï½¾':'ã‚»','ï½¿':'ã‚½','ï¾€':'ã‚¿','ï¾':'ãƒ','ï¾‚':'ãƒ„','ï¾ƒ':'ãƒ†','ï¾„':'ãƒˆ',
        'ï¾…':'ãƒŠ','ï¾†':'ãƒ‹','ï¾‡':'ãƒŒ','ï¾ˆ':'ãƒ','ï¾‰':'ãƒ','ï¾Š':'ãƒ','ï¾‹':'ãƒ’','ï¾Œ':'ãƒ•','ï¾':'ãƒ˜','ï¾':'ãƒ›',
        'ï¾':'ãƒ','ï¾':'ãƒŸ','ï¾‘':'ãƒ ','ï¾’':'ãƒ¡','ï¾“':'ãƒ¢','ï¾”':'ãƒ¤','ï¾•':'ãƒ¦','ï¾–':'ãƒ¨',
        'ï¾—':'ãƒ©','ï¾˜':'ãƒª','ï¾™':'ãƒ«','ï¾š':'ãƒ¬','ï¾›':'ãƒ­','ï¾œ':'ãƒ¯','ï½¦':'ãƒ²','ï¾':'ãƒ³',
        'ï½§':'ã‚¡','ï½¨':'ã‚£','ï½©':'ã‚¥','ï½ª':'ã‚§','ï½«':'ã‚©','ï½¯':'ãƒƒ','ï½¬':'ãƒ£','ï½­':'ãƒ¥','ï½®':'ãƒ§',
        'ï½¡':'ã€‚','ï½¢':'ã€Œ','ï½£':'ã€','ï½¤':'ã€','ï½¥':'ãƒ»','ï½°':'ãƒ¼','ï¾':'ã‚›','ï¾Ÿ':'ã‚œ'
    };
    const kanaRegex = new RegExp('(' + Object.keys(kanaMap).sort((a,b)=>b.length-a.length).join('|') + ')', 'g');

    // ã‚¦ãƒå¨˜ç•¥ç§°å¤‰æ›ãƒãƒƒãƒ— (ãƒˆãƒ¬ãƒ¼ãƒŠãƒ¼ã‚’è¿½åŠ )
    const umaMap = {
        'ã‚¹ãƒšã‚·ãƒ£ãƒ«ã‚¦ã‚£ãƒ¼ã‚¯': 'SW', 'ã‚µã‚¤ãƒ¬ãƒ³ã‚¹ã‚¹ã‚ºã‚«': 'SSZ', 'ãƒˆã‚¦ã‚«ã‚¤ãƒ†ã‚¤ã‚ªãƒ¼': 'TT', 'ãƒãƒ«ã‚¼ãƒ³ã‚¹ã‚­ãƒ¼': 'MZ',
        'ãƒ•ã‚¸ã‚­ã‚»ã‚­': 'FK', 'ã‚ªã‚°ãƒªã‚­ãƒ£ãƒƒãƒ—': 'OC', 'ã‚´ãƒ¼ãƒ«ãƒ‰ã‚·ãƒƒãƒ—': 'GS', 'ã‚¦ã‚ªãƒƒã‚«': 'VDK',
        'ãƒ€ã‚¤ãƒ¯ã‚¹ã‚«ãƒ¼ãƒ¬ãƒƒãƒˆ': 'DS', 'ã‚¿ã‚¤ã‚­ã‚·ãƒ£ãƒˆãƒ«': 'TS', 'ã‚°ãƒ©ã‚¹ãƒ¯ãƒ³ãƒ€ãƒ¼': 'GW', 'ãƒ’ã‚·ã‚¢ãƒã‚¾ãƒ³': 'HA',
        'ãƒ¡ã‚¸ãƒ­ãƒãƒƒã‚¯ã‚¤ãƒ¼ãƒ³': 'MMQ', 'ã‚¨ãƒ«ã‚³ãƒ³ãƒ‰ãƒ«ãƒ‘ã‚µãƒ¼': 'ECP', 'ãƒ†ã‚¤ã‚¨ãƒ ã‚ªãƒšãƒ©ã‚ªãƒ¼': 'TMO', 'ãƒŠãƒªã‚¿ãƒ–ãƒ©ã‚¤ã‚¢ãƒ³': 'NB',
        'ã‚·ãƒ³ãƒœãƒªãƒ«ãƒ‰ãƒ«ãƒ•': 'SR', 'ã‚¨ã‚¢ã‚°ãƒ«ãƒ¼ãƒ´': 'AG', 'ã‚¢ã‚°ãƒã‚¹ãƒ‡ã‚¸ã‚¿ãƒ«': 'AD', 'ã‚»ã‚¤ã‚¦ãƒ³ã‚¹ã‚«ã‚¤': 'SUS',
        'ã‚¿ãƒãƒ¢ã‚¯ãƒ­ã‚¹': 'TC', 'ãƒ•ã‚¡ã‚¤ãƒ³ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³': 'FM', 'ãƒ“ãƒ¯ãƒãƒ¤ãƒ’ãƒ‡': 'BHH', 'ãƒãƒ¤ãƒãƒˆãƒƒãƒ—ã‚¬ãƒ³': 'MTG',
        'ãƒãƒ³ãƒãƒƒã‚¿ãƒ³ã‚«ãƒ•ã‚§': 'MC', 'ãƒŸãƒ›ãƒãƒ–ãƒ«ãƒœãƒ³': 'MB', 'ãƒ¡ã‚¸ãƒ­ãƒ©ã‚¤ã‚¢ãƒ³': 'MR', 'ãƒ’ã‚·ã‚¢ã‚±ãƒœãƒ': 'HAK',
        'ãƒ¦ã‚­ãƒãƒ“ã‚¸ãƒ³': 'YB', 'ãƒ©ã‚¤ã‚¹ã‚·ãƒ£ãƒ¯ãƒ¼': 'RS', 'ã‚¢ã‚¤ãƒã‚¹ãƒ•ã‚¦ã‚¸ãƒ³': 'AF', 'ã‚¢ã‚°ãƒã‚¹ã‚¿ã‚­ã‚ªãƒ³': 'AT',
        'ã‚¢ãƒ‰ãƒã‚¤ãƒ¤ãƒ™ã‚¬': 'AV', 'ã‚¤ãƒŠãƒªãƒ¯ãƒ³': 'IW', 'ã‚¦ã‚¤ãƒ‹ãƒ³ã‚°ãƒã‚±ãƒƒãƒˆ': 'WT', 'ã‚¨ã‚¢ã‚·ãƒ£ã‚«ãƒ¼ãƒ«': 'ASK',
        'ã‚¨ã‚¤ã‚·ãƒ³ãƒ•ãƒ©ãƒƒã‚·ãƒ¥': 'EF', 'ã‚«ãƒ¬ãƒ³ãƒãƒ£ãƒ³': 'CC', 'ã‚«ãƒ¯ã‚«ãƒŸãƒ—ãƒªãƒ³ã‚»ã‚¹': 'KP', 'ã‚´ãƒ¼ãƒ«ãƒ‰ã‚·ãƒãƒ¼': 'GC',
        'ã‚µã‚¯ãƒ©ãƒã‚¯ã‚·ãƒ³ã‚ªãƒ¼': 'SBO', 'ã‚·ãƒ¼ã‚­ãƒ³ã‚°ã‚¶ãƒ‘ãƒ¼ãƒ«': 'SZP', 'ã‚·ãƒ³ã‚³ã‚¦ã‚¦ã‚¤ãƒ³ãƒ‡ã‚£': 'SKW', 'ã‚¹ã‚¤ãƒ¼ãƒ—ãƒˆã‚¦ã‚·ãƒ§ã‚¦': 'SWT',
        'ã‚¹ãƒ¼ãƒ‘ãƒ¼ã‚¯ãƒªãƒ¼ã‚¯': 'SCR', 'ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚¡ãƒ«ã‚³ãƒ³': 'SF', 'ã‚¼ãƒ³ãƒãƒ­ãƒ–ãƒ­ã‚¤': 'ZRR', 'ãƒˆãƒ¼ã‚»ãƒ³ã‚¸ãƒ§ãƒ¼ãƒ€ãƒ³': 'TJ',
        'ãƒŠã‚«ãƒ¤ãƒãƒ•ã‚§ã‚¹ã‚¿': 'NF', 'ãƒŠãƒªã‚¿ã‚¿ã‚¤ã‚·ãƒ³': 'NT', 'ãƒ‹ã‚·ãƒãƒ•ãƒ©ãƒ¯ãƒ¼': 'NIF', 'ãƒãƒ«ã‚¦ãƒ©ãƒ©': 'HU',
        'ãƒãƒ³ãƒ–ãƒ¼ãƒ¡ãƒ¢ãƒªãƒ¼': 'BM', 'ãƒ“ã‚³ãƒ¼ãƒšã‚¬ã‚µã‚¹': 'BP', 'ãƒãƒ¼ãƒ™ãƒ©ã‚¹ã‚µãƒ³ãƒ‡ãƒ¼': 'MVS', 'ãƒãƒã‚«ãƒãƒ•ã‚¯ã‚­ã‚¿ãƒ«': 'MFK',
        'ãƒŸã‚¹ã‚¿ãƒ¼ã‚·ãƒ¼ãƒ“ãƒ¼': 'MCB', 'ãƒ¡ã‚¤ã‚·ãƒ§ã‚¦ãƒ‰ãƒˆã‚¦': 'MSD', 'ãƒ¡ã‚¸ãƒ­ãƒ‰ãƒ¼ãƒ™ãƒ«': 'MD', 'ãƒŠã‚¤ã‚¹ãƒã‚¤ãƒãƒ£': 'NN',
        'ã‚­ãƒ³ã‚°ãƒ˜ã‚¤ãƒ­ãƒ¼': 'KH', 'ãƒãƒã‚«ãƒã‚¿ãƒ³ãƒ›ã‚¤ã‚¶': 'MTH', 'ã‚¤ã‚¯ãƒãƒ‡ã‚£ã‚¯ã‚¿ã‚¹': 'ID', 'ãƒ¡ã‚¸ãƒ­ãƒ‘ãƒ¼ãƒãƒ¼': 'MP',
        'ãƒ€ã‚¤ã‚¿ã‚¯ãƒ˜ãƒªã‚ªã‚¹': 'DTH', 'ãƒ„ã‚¤ãƒ³ã‚¿ãƒ¼ãƒœ': 'TTB', 'ã‚µãƒˆãƒãƒ€ã‚¤ãƒ¤ãƒ¢ãƒ³ãƒ‰': 'SDD', 'ã‚­ã‚¿ã‚µãƒ³ãƒ–ãƒ©ãƒƒã‚¯': 'KB',
        'ã‚µã‚¯ãƒ©ãƒãƒ¨ãƒã‚ªãƒ¼': 'SCO', 'ã‚·ãƒªã‚¦ã‚¹ã‚·ãƒ³ãƒœãƒª': 'SSB', 'ãƒ¡ã‚¸ãƒ­ã‚¢ãƒ«ãƒ€ãƒ³': 'MA', 'ãƒ¤ã‚¨ãƒãƒ ãƒ†ã‚­': 'YM',
        'ãƒ„ãƒ«ãƒãƒ«ãƒ„ãƒ¨ã‚·': 'TMT', 'ãƒ¡ã‚¸ãƒ­ãƒ–ãƒ©ã‚¤ãƒˆ': 'MBR', 'ã‚µã‚¯ãƒ©ãƒ­ãƒ¼ãƒ¬ãƒ«': 'SL', 'ãƒŠãƒªã‚¿ãƒˆãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰': 'NTR',
        'ãƒ¤ãƒãƒ‹ãƒ³ã‚¼ãƒ•ã‚¡ãƒ¼': 'YZ', 'ãƒ•ãƒªã‚ªãƒ¼ã‚½': 'FRI', 'ãƒˆãƒ©ãƒ³ã‚»ãƒ³ãƒ‰': 'TRC', 'ã‚¨ã‚¹ãƒãƒ¯ãƒ¼ãƒ«ã‚·ãƒãƒ¼': 'ESC',
        'ãƒãƒ¼ã‚¹ãƒ•ãƒ©ã‚¤ãƒˆ': 'NFL', 'ã‚·ãƒ³ãƒœãƒªã‚¯ãƒªã‚¹ã‚¨ã‚¹': 'SKS', 'ã‚¿ãƒ‹ãƒã‚®ãƒ ãƒ¬ãƒƒãƒˆ': 'TG', 'ãƒ€ã‚¤ã‚¤ãƒãƒ«ãƒ“ãƒ¼': 'DIR',
        'ãƒ¡ã‚¸ãƒ­ãƒ©ãƒ¢ãƒ¼ãƒŒ': 'MLM', 'ã‚¢ã‚¹ãƒˆãƒ³ãƒãƒ¼ãƒãƒ£ãƒ³': 'AM', 'ã‚µãƒˆãƒã‚¯ãƒ©ã‚¦ãƒ³': 'SCW', 'ã‚·ãƒ¥ãƒ´ã‚¡ãƒ«ã‚°ãƒ©ãƒ³': 'SVG',
        'ãƒ´ã‚£ãƒ«ã‚·ãƒ¼ãƒŠ': 'VRS', 'ãƒ´ã‚£ãƒ–ãƒ­ã‚¹': 'VIV', 'ãƒ€ãƒ³ãƒ„ãƒ•ãƒ¬ãƒ¼ãƒ ': 'DF', 'ã‚±ã‚¤ã‚¨ã‚¹ãƒŸãƒ©ã‚¯ãƒ«': 'KSM',
        'ã‚¸ãƒ£ãƒ³ã‚°ãƒ«ãƒã‚±ãƒƒãƒˆ': 'JP', 'ãƒ“ãƒªãƒ¼ãƒ´': 'BLV', 'ãƒãƒ¼ãƒªãƒ¼ã‚ºãƒ³': 'NR', 'ã‚¹ãƒ†ã‚£ãƒ«ã‚¤ãƒ³ãƒ©ãƒ–': 'SIL',
        'ã‚³ãƒ‘ãƒãƒªãƒƒã‚­ãƒ¼': 'CPR', 'ãƒ›ãƒƒã‚³ãƒ¼ã‚¿ãƒ«ãƒã‚¨': 'HT', 'ãƒ¯ãƒ³ãƒ€ãƒ¼ã‚¢ã‚­ãƒ¥ãƒ¼ãƒˆ': 'WA', 'ã‚µã‚¦ãƒ³ã‚ºã‚ªãƒ–ã‚¢ãƒ¼ã‚¹': 'SOE',
        'ãƒ­ã‚¤ã‚¹ã‚¢ãƒ³ãƒ‰ãƒ­ã‚¤ã‚¹': 'RAR', 'ã‚«ãƒ„ãƒ©ã‚®ã‚¨ãƒ¼ã‚¹': 'KA', 'ãƒã‚ªãƒ¦ãƒ‹ãƒ´ã‚¡ãƒ¼ã‚¹': 'NU', 'ãƒ’ã‚·ãƒŸãƒ©ã‚¯ãƒ«': 'HM',
        'ã‚¿ãƒƒãƒ—ãƒ€ãƒ³ã‚¹ã‚·ãƒãƒ¼': 'TDS', 'ãƒ‰ã‚¥ãƒ©ãƒ¡ãƒ³ãƒ†': 'DRM', 'ãƒ©ã‚¤ãƒ³ã‚¯ãƒ©ãƒ•ãƒˆ': 'RK', 'ã‚·ãƒ¼ã‚¶ãƒªã‚ª': 'CZR',
        'ã‚¨ã‚¢ãƒ¡ã‚µã‚¤ã‚¢': 'AMS', 'ãƒ•ã‚µã‚¤ãƒãƒ‘ãƒ³ãƒ‰ãƒ©': 'FP', 'ãƒ–ã‚¨ãƒŠãƒ“ã‚¹ã‚¿': 'BV', 'ã‚ªãƒ«ãƒ•ã‚§ãƒ¼ãƒ´ãƒ«': 'ORF',
        'ã‚¸ã‚§ãƒ³ãƒ†ã‚£ãƒ«ãƒ‰ãƒ³ãƒŠ': 'GD', 'ã‚¦ã‚¤ãƒ³ãƒãƒªã‚¢ã‚·ã‚ªãƒ³': 'WV', 'ãƒ‰ãƒªãƒ¼ãƒ ã‚¸ãƒ£ãƒ¼ãƒ‹ãƒ¼': 'DJ', 'ã‚«ãƒ«ã‚¹ãƒˆãƒ³ãƒ©ã‚¤ãƒˆã‚ª': 'CLO',
        'ãƒ‡ãƒ¥ãƒ©ãƒ³ãƒ€ãƒ«': 'DRD', 'ãƒãƒ–ãƒ«ã‚¬ãƒ ãƒ•ã‚§ãƒ­ãƒ¼': 'BGF', 'ãƒ•ã‚§ãƒãƒ¼ãƒ¡ãƒ': 'FNM', 'ã‚°ãƒ©ãƒ³ã‚¢ãƒ¬ã‚°ãƒªã‚¢': 'GAL',
        'ãƒ©ãƒ´ã‚ºã‚ªãƒ³ãƒªãƒ¼ãƒ¦ãƒ¼': 'LOY', 'ã‚¯ãƒ­ãƒã‚¸ã‚§ãƒã‚·ã‚¹': 'CG', 'ã‚¹ãƒ†ã‚¤ã‚´ãƒ¼ãƒ«ãƒ‰': 'STG', 'ã‚­ã‚»ã‚­': 'KSK',
        'ãƒ‡ã‚¢ãƒªãƒ³ã‚°ã‚¿ã‚¯ãƒˆ': 'DAT', 'ãƒ‡ã‚¢ãƒªãƒ³ã‚°ãƒãƒ¼ãƒˆ': 'DAH', 'ã‚¢ãƒ‰ãƒã‚¤ãƒ¤ã‚°ãƒ«ãƒ¼ãƒ´': 'AMG', 'ã‚µã‚¯ãƒ©ãƒãƒˆã‚»ã‚ªãƒ¼': 'SCT',
        'ãƒ–ãƒ©ã‚¹ãƒˆãƒ¯ãƒ³ãƒ”ãƒ¼ã‚¹': 'BWP', 'ã‚¢ãƒ¼ãƒ¢ãƒ³ãƒ‰ã‚¢ã‚¤': 'AAI', 'ãƒ©ãƒƒã‚­ãƒ¼ãƒ©ã‚¤ãƒ©ãƒƒã‚¯': 'LL', 'ã‚«ãƒ¬ãƒ³ãƒ–ãƒ¼ã‚±ãƒ‰ãƒ¼ãƒ«': 'CBD',
        'ãƒ¬ãƒƒãƒ‰ãƒ‡ã‚£ã‚¶ã‚¤ã‚¢': 'RD', 'ãƒ€ãƒ¼ãƒ¬ãƒ¼ã‚¢ãƒ©ãƒ“ã‚¢ãƒ³': 'DLA', 'ã‚´ãƒ‰ãƒ«ãƒ•ã‚£ãƒ³ãƒãƒ«ãƒ–': 'GOB', 'ãƒã‚¤ã‚¢ãƒªãƒ¼ã‚¿ãƒ¼ã‚¯': 'BYT',
        'ã‚»ãƒ³ãƒˆãƒ©ã‚¤ãƒˆ': 'SNL', 'ã‚¹ãƒ”ãƒ¼ãƒ‰ã‚·ãƒ³ãƒœãƒª': 'SPS', 'ãƒã‚¤ã‚»ã‚¤ã‚³ãƒ¼': 'HSK', 'ãƒ¢ãƒ³ã‚¸ãƒ¥ãƒ¼': 'MNJ',
        'ãƒãƒƒãƒ”ãƒ¼ãƒŸãƒ¼ã‚¯': 'HPM', 'ãƒ“ã‚¿ãƒ¼ã‚°ãƒ©ãƒƒã‚»': 'BTG', 'ãƒªãƒˆãƒ«ã‚³ã‚³ãƒ³': 'LCC', 'ãƒ©ã‚¤ãƒˆãƒãƒ­ãƒ¼': 'LH',
        'ãƒ´ã‚§ãƒ‹ãƒ¥ã‚¹ãƒ‘ãƒ¼ã‚¯': 'VP', 'ãƒªã‚¬ãƒ³ãƒˆãƒ¼ãƒŠ': 'RGT', 'ã‚½ãƒãƒ³ã‚¨ãƒ«ãƒ•ã‚£ãƒ¼': 'SEF', 'ã‚·ãƒ¥ã‚¬ãƒ¼ãƒ©ã‚¤ãƒ„': 'SGL',
        'ã‚¿ãƒƒã‚«ãƒ¼ãƒ–ãƒ©ã‚¤ãƒ³': 'TKB', 'ãƒ¦ãƒãƒãƒŠãƒ–ãƒ«ãƒ¼ãƒ ': 'YHB', 'é§¿å·ãŸã¥ãª': 'HT2', 'ç§‹å·ã‚„ã‚ˆã„': 'AY',
        'ä¹™åå²æ‚¦å­': 'OE', 'æ¡ç”Ÿé™¢è‘µ': 'KA2', 'å®‰å¿ƒæ²¢åˆºã€…ç¾': 'ASS', 'æ¨«æœ¬ç†å­': 'KR', 'ä½å²³ãƒ¡ã‚¤': 'SM',
        'éƒ½ç•™å²æ¶¼èŠ±': 'TR', 'ä¿ç§‘å¥å­': 'HK', 'èµ¤å‚ç¾è¡': 'AKM', 'ç´°æ±Ÿç´”å­': 'HJ',
        'ãƒˆãƒ¬ãƒ¼ãƒŠãƒ¼': 'TNR'
    };
    const umaRegex = new RegExp('(' + Object.keys(umaMap).sort((a,b)=>b.length-a.length).join('|') + ')', 'g');

    function formatText(action) {
        let text = inputEl.value;
        if (!text) {
            showToast('å…¥åŠ›ãƒ†ã‚­ã‚¹ãƒˆãŒã‚ã‚Šã¾ã›ã‚“');
            return;
        }

        switch (action) {
            case 'trimSpace': 
                text = text.replace(/[ ã€€\t]+/g, ''); 
                break;
            case 'removeEmptyLines': 
                text = text.replace(/^\s*[\r\n]/gm, ''); 
                break;
            case 'removeBreaks': 
                text = text.replace(/[\r\n]+/g, ''); 
                break;
            case 'breaksToSpace': 
                text = text.replace(/[\r\n]+/g, ' ').trim(); 
                break;
            case 'toHalfWidth': 
                text = text.replace(/[ï¼¡-ï¼ºï½-ï½šï¼-ï¼™]/g, s => String.fromCharCode(s.charCodeAt(0) - 0xFEE0)); 
                break;
            case 'toFullWidthKana': 
                text = text.replace(kanaRegex, match => kanaMap[match]); 
                break;
            case 'toUpperCase': 
                text = text.toUpperCase(); 
                break;
            case 'toLowerCase': 
                text = text.toLowerCase(); 
                break;
            case 'toUmaAbbr': {
                const replaced = new Map();
                let isReplaced = false;

                text = text.replace(umaRegex, match => {
                    replaced.set(match, umaMap[match]);
                    isReplaced = true;
                    return umaMap[match];
                });

                if (isReplaced) {
                    let noteStr = "ã€é©ç”¨ã•ã‚ŒãŸç•¥ç§°ä¸€è¦§ã€‘\n";
                    replaced.forEach((abbr, name) => {
                        noteStr += `ãƒ»${name} â†’ ${abbr}\n`;
                    });
                    noteStr += "------------------------\n\n";
                    text = noteStr + text;
                    showToast('ã‚¦ãƒå¨˜ãƒ»ãƒˆãƒ¬ãƒ¼ãƒŠãƒ¼ã®ç•¥ç§°åŒ–ã‚’è¡Œã„ã¾ã—ãŸï¼');
                } else {
                    showToast('ç•¥ç§°åŒ–ã§ãã‚‹å˜èªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
                    return; 
                }
                break;
            }
        }
        outputEl.value = text;
        updateCounts();
    }

    document.querySelectorAll('.tools-grid .tool-btn').forEach(btn => {
        btn.addEventListener('click', (e) => formatText(e.target.getAttribute('data-action')));
    });

    // ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã‹ã‚‰è²¼ã‚Šä»˜ã‘
    document.getElementById('pasteBtn').addEventListener('click', async () => {
        try {
            const text = await navigator.clipboard.readText();
            if (text) {
                const selectionStart = inputEl.selectionStart;
                const selectionEnd = inputEl.selectionEnd;
                const currentText = inputEl.value;
                
                inputEl.value = currentText.substring(0, selectionStart) + text + currentText.substring(selectionEnd);
                inputEl.selectionStart = inputEl.selectionEnd = selectionStart + text.length;
                inputEl.focus();
                
                updateCounts();
                showToast('è²¼ã‚Šä»˜ã‘ã¾ã—ãŸ');
            } else {
                showToast('ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ãŒç©ºã§ã™');
            }
        } catch (err) {
            showToast('è²¼ã‚Šä»˜ã‘ãŒè¨±å¯ã•ã‚Œã¦ã„ã¾ã›ã‚“');
        }
    });

    // ä»»æ„æ–‡å­—åˆ—ã®ç½®æ›ãƒ­ã‚¸ãƒƒã‚¯
    document.getElementById('replaceBtn').addEventListener('click', () => {
        const source = document.getElementById('replaceSource').value;
        const target = document.getElementById('replaceTarget').value;
        let text = inputEl.value;

        if (!text) {
            showToast('å…¥åŠ›ãƒ†ã‚­ã‚¹ãƒˆãŒã‚ã‚Šã¾ã›ã‚“');
            return;
        }
        if (!source) {
            showToast('æ¤œç´¢æ–‡å­—åˆ—ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
            return;
        }

        const escapeRegExp = (string) => string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        const regex = new RegExp(escapeRegExp(source), 'g');
        
        outputEl.value = text.replace(regex, target);
        updateCounts();
        showToast('ç½®æ›ã—ã¾ã—ãŸ');
    });

    // ãã®ä»–UIãƒœã‚¿ãƒ³
    document.getElementById('clearBtn').addEventListener('click', () => {
        inputEl.value = ''; outputEl.value = ''; updateCounts();
    });

    document.getElementById('applyToInputBtn').addEventListener('click', () => {
        if (outputEl.value) {
            inputEl.value = outputEl.value;
            outputEl.value = '';
            updateCounts();
            showToast('å…¥åŠ›æ¬„ã«åæ˜ ã—ã¾ã—ãŸ');
        }
    });

    document.getElementById('copyBtn').addEventListener('click', async () => {
        if (!outputEl.value) return;
        try {
            await navigator.clipboard.writeText(outputEl.value);
            showToast('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼');
        } catch (err) {
            showToast('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
    });

    let toastTimeout;
    function showToast(message) {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.classList.add('show');
        clearTimeout(toastTimeout);
        toastTimeout = setTimeout(() => toast.classList.remove('show'), 2000);
    }
</script>
</body>
</html>
